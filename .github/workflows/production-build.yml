name: Production Build & Asset Optimization

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-optimize:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install --legacy-peer-deps
    
    - name: Build with production optimizations
      env:
        NODE_ENV: production
      run: |
        echo "ðŸš€ Starting production build..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # ë¹Œë“œ ì‹œìž‘ ì‹œê°„ ì¸¡ì •
        START_TIME=$(date +%s)
        
        # Production ë¹Œë“œ ì‹¤í–‰
        npm run build
        
        # ë¹Œë“œ ì¢…ë£Œ ì‹œê°„ ì¸¡ì •
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        
        echo ""
        echo "âœ… Build completed in ${BUILD_TIME}s"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Analyze build output
      run: |
        echo ""
        echo "ðŸ“Š Build Analysis Report"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # ì „ì²´ dist í´ë” í¬ê¸°
        TOTAL_SIZE=$(du -sh dist | cut -f1)
        TOTAL_SIZE_BYTES=$(du -sb dist | cut -f1)
        echo "ðŸ“¦ Total dist folder: $TOTAL_SIZE ($TOTAL_SIZE_BYTES bytes)"
        
        echo ""
        echo "ðŸ“„ Individual asset sizes:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # JavaScript íŒŒì¼
        echo ""
        echo "JavaScript files:"
        find dist -type f -name "*.js" | sort | while read file; do
          SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          SIZE_KB=$(echo "scale=1; $SIZE/1024" | bc)
          GZIP_SIZE=$(gzip -c "$file" | wc -c)
          GZIP_KB=$(echo "scale=1; $GZIP_SIZE/1024" | bc)
          RATIO=$(echo "scale=1; ($GZIP_SIZE*100)/$SIZE" | bc)
          FILENAME=$(basename "$file")
          echo "  ðŸ“œ $FILENAME"
          echo "      Original: ${SIZE_KB}KB | Gzipped: ${GZIP_KB}KB (${RATIO}%)"
        done
        
        # CSS íŒŒì¼
        echo ""
        echo "CSS files:"
        find dist -type f -name "*.css" | sort | while read file; do
          SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          SIZE_KB=$(echo "scale=1; $SIZE/1024" | bc)
          GZIP_SIZE=$(gzip -c "$file" | wc -c)
          GZIP_KB=$(echo "scale=1; $GZIP_SIZE/1024" | bc)
          RATIO=$(echo "scale=1; ($GZIP_SIZE*100)/$SIZE" | bc)
          FILENAME=$(basename "$file")
          echo "  ðŸŽ¨ $FILENAME"
          echo "      Original: ${SIZE_KB}KB | Gzipped: ${GZIP_KB}KB (${RATIO}%)"
        done
        
        # HTML íŒŒì¼
        echo ""
        echo "HTML files:"
        find dist -type f -name "*.html" | sort | while read file; do
          SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          SIZE_KB=$(echo "scale=1; $SIZE/1024" | bc)
          GZIP_SIZE=$(gzip -c "$file" | wc -c)
          GZIP_KB=$(echo "scale=1; $GZIP_SIZE/1024" | bc)
          RATIO=$(echo "scale=1; ($GZIP_SIZE*100)/$SIZE" | bc)
          FILENAME=$(basename "$file")
          echo "  ðŸ“° $FILENAME"
          echo "      Original: ${SIZE_KB}KB | Gzipped: ${GZIP_KB}KB (${RATIO}%)"
        done
        
        # ì´ë¯¸ì§€ íŒŒì¼
        echo ""
        echo "Image files:"
        find dist -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.webp" \) | sort | while read file; do
          SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          SIZE_KB=$(echo "scale=1; $SIZE/1024" | bc)
          FILENAME=$(basename "$file")
          echo "  ðŸ–¼ï¸  $FILENAME: ${SIZE_KB}KB"
        done
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # íŒŒì¼ ê°œìˆ˜ í†µê³„
        JS_COUNT=$(find dist -type f -name "*.js" | wc -l)
        CSS_COUNT=$(find dist -type f -name "*.css" | wc -l)
        HTML_COUNT=$(find dist -type f -name "*.html" | wc -l)
        IMG_COUNT=$(find dist -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.webp" \) | wc -l)
        
        echo ""
        echo "ðŸ“ˆ File Statistics:"
        echo "  JavaScript: $JS_COUNT files"
        echo "  CSS: $CSS_COUNT files"
        echo "  HTML: $HTML_COUNT files"
        echo "  Images: $IMG_COUNT files"
        
        # Android AAB ì˜ˆìƒ í¬ê¸° (ëŒ€ëžµì ì¸ ì¶”ì •)
        echo ""
        echo "ðŸ“± Android Build Estimation:"
        AAB_EST=$(echo "scale=1; ($TOTAL_SIZE_BYTES + 2000000)/1024/1024" | bc)
        echo "  Estimated AAB size: ~${AAB_EST}MB"
        echo "  (includes app overhead + assets)"
        
        echo ""
        echo "âœ… Analysis complete!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Check for large assets
      run: |
        echo ""
        echo "âš ï¸  Checking for oversized assets..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # 500KB ì´ìƒì˜ íŒŒì¼ ì°¾ê¸°
        LARGE_FILES=$(find dist -type f -size +500k)
        
        if [ -z "$LARGE_FILES" ]; then
          echo "âœ… No assets larger than 500KB found!"
        else
          echo "âš ï¸  Large assets found (>500KB):"
          echo "$LARGE_FILES" | while read file; do
            SIZE=$(du -h "$file" | cut -f1)
            echo "  - $file: $SIZE"
          done
          echo ""
          echo "ðŸ’¡ Consider optimizing these assets for better performance."
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Upload production build
      uses: actions/upload-artifact@v4
      with:
        name: production-build-${{ github.sha }}
        path: dist/
        retention-days: 30
    
    - name: Create build summary
      run: |
        echo "## ðŸš€ Production Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        TOTAL_SIZE=$(du -sh dist | cut -f1)
        echo "- **Total Size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
        
        JS_COUNT=$(find dist -type f -name "*.js" | wc -l)
        CSS_COUNT=$(find dist -type f -name "*.css" | wc -l)
        
        echo "- **JavaScript files:** $JS_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- **CSS files:** $CSS_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸŽ¯ Optimizations Applied" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Terser minification" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dead code elimination" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Console.log removal" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Code splitting (Pixi.js, Vendor)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… CSS optimization" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Asset hashing for cache optimization" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“¦ Artifact" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Production build artifact uploaded: \`production-build-${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

